name: valiDTr Self-Test

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  selftest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build valiDTr from this repo
        shell: bash
        run: |
          set -euo pipefail
          go test ./...
          go build -o "$RUNNER_TEMP/valiDTr" .
          echo "$RUNNER_TEMP" >> "$GITHUB_PATH"

      - name: Demo PASS -> FAIL (current), old commit still PASS (historical)
        shell: bash
        run: |
          set -euo pipefail

          WORK="$RUNNER_TEMP/demo"
          mkdir -p "$WORK"
          cd "$WORK"
          git init

          # GPG setup
          export GNUPGHOME="$RUNNER_TEMP/gnupg"
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"

          cat >keyparams <<'EOF'
          Key-Type: RSA
          Key-Length: 3072
          Subkey-Type: RSA
          Subkey-Length: 3072
          Name-Real: Demo Dev
          Name-Email: demo@example.com
          Expire-Date: 0
          %no-protection
          %commit
          EOF

          gpg --batch --pinentry-mode loopback --generate-key keyparams

          gpg --batch --generate-key keyparams
          FPR="$(gpg --list-secret-keys --with-colons demo@example.com | awk -F: '$1=="fpr"{print $10; exit}')"

          mkdir -p .validtr/pubkeys
          gpg --armor --export "$FPR" > .validtr/pubkeys/demo.asc
          gpg --batch --import .validtr/pubkeys/demo.asc >/dev/null

          # Git signing config
          git config user.name "Demo Dev"
          git config user.email "demo@example.com"
          git config commit.gpgsign true
          git config user.signingkey "$FPR"

          echo "hello" > file.txt
          git add file.txt
          git commit -m "signed commit 1"
          COMMIT1="$(git rev-parse HEAD)"
          KEYID="$(git show -s --format=%GK HEAD)"

          export VALIDTR_DB="$RUNNER_TEMP/validtr.db"
          rm -f "$VALIDTR_DB"

          # IMPORTANT: selftest uses the CLI time-window commands (Option 2)
          valiDTr add-dev demo@example.com --name "Demo Dev"
          valiDTr add-key demo@example.com "$KEYID"

          ROOT="$(git rev-list --max-parents=0 HEAD)"
          echo "✅ Expect PASS (policy=current)"
          valiDTr --policy=current verify-range "$ROOT" "$COMMIT1"

          # Remove dev, then create another signed commit
          valiDTr remove-dev demo@example.com

          echo "world" >> file.txt
          git add file.txt
          git commit -m "signed commit 2 after removal"
          COMMIT2="$(git rev-parse HEAD)"

          echo "❌ Expect FAIL (policy=current) because dev removed"
          set +e
          valiDTr --policy=current verify-range "$COMMIT1" "$COMMIT2"
          RC=$?
          set -e
          if [ "$RC" -eq 0 ]; then
            echo "ERROR: expected failure but got success"
            exit 1
          fi

          echo "✅ Expect PASS: old commit stays valid under policy=historical"
          valiDTr --policy=historical verify "$COMMIT1"

          {
            echo "### valiDTr self-test results"
            echo "- Commit1 (before removal): $COMMIT1"
            echo "- Commit2 (after removal):  $COMMIT2"
            echo "- KeyID:                   $KEYID"
            echo "- Expected: PASS → FAIL(current), and Commit1 PASS(historical)"
          } >> "$GITHUB_STEP_SUMMARY"
