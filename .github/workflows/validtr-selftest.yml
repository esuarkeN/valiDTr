name: valiDTr Self-Test

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  selftest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: actions/setup-go@v6.2.0
        with:
          go-version: "1.23"

      - name: Build valiDTr from this repo
        shell: bash
        run: |
          set -euo pipefail
          go test ./...
          go build -o "$RUNNER_TEMP/valiDTr" .
          echo "$RUNNER_TEMP" >> "$GITHUB_PATH"

      - name: Demo PASS -> FAIL (current), old commit still PASS (historical)
        shell: bash
        run: |
          set -euo pipefail

          WORK="$RUNNER_TEMP/demo"
          mkdir -p "$WORK"
          cd "$WORK"
          git init -b main

          export GNUPGHOME="$RUNNER_TEMP/gnupg"
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"

          cat >keyparams <<'EOF'
          Key-Type: RSA
          Key-Length: 3072
          Subkey-Type: RSA
          Subkey-Length: 3072
          Name-Real: Demo Dev
          Name-Email: demo@example.com
          Expire-Date: 0
          %no-protection
          %commit
          EOF

          gpg --batch --pinentry-mode loopback --generate-key keyparams

          # fingerprint for signing config + exporting pubkey
          FPR="$(gpg --list-secret-keys --with-colons demo@example.com | awk -F: '$1=="fpr"{print $10; exit}')"

          # Git signing config
          git config user.name "Demo Dev"
          git config user.email "demo@example.com"
          git config commit.gpgsign true
          git config user.signingkey "$FPR"

          export GIT_AUTHOR_DATE="2020-01-01T00:00:00Z"
          export GIT_COMMITTER_DATE="2020-01-01T00:00:00Z"

          echo "hello" > file.txt
          git add file.txt
          git commit -m "signed commit 1"

          unset GIT_AUTHOR_DATE GIT_COMMITTER_DATE

          COMMIT1="$(git rev-parse HEAD)"
          ROOT="$(git rev-list --max-parents=0 HEAD)"

          KEYID="$(git show -s --format=%GK "$COMMIT1")"
          echo "Commit1 key id (git %GK): $KEYID"

          mkdir -p .validtr/pubkeys
          gpg --armor --export "$FPR" > .validtr/pubkeys/demo.asc
          gpg --batch --import .validtr/pubkeys/demo.asc >/dev/null

          mkdir -p .validtr
          cat > .validtr/config.yml <<EOF
          developers:
            - email: demo@example.com
              name: Demo Dev
              keys:
                - id: ${KEYID}
          EOF

          export VALIDTR_DB="$RUNNER_TEMP/validtr.db"
          rm -f "$VALIDTR_DB"

          valiDTr sync --config .validtr/config.yml --mode=reconcile

          echo "✅ Expect PASS (policy=current)"
          valiDTr --policy=current verify-range "$ROOT" "$COMMIT1"

          echo "✅ Expect PASS (policy=historical)"
          valiDTr --policy=historical verify "$COMMIT1"

          echo "✅ Expect PASS (email_mode=author)"
          GIT_AUTHOR_NAME="Demo Dev" GIT_AUTHOR_EMAIL="demo@example.com" \
            valiDTr --policy=current --email-mode=author verify "$COMMIT1"

          # Revoke key (keep developer, remove key from allowlist)
          cat > .validtr/config.yml <<EOF
          developers:
            - email: demo@example.com
              name: Demo Dev
              keys: []
          EOF
          valiDTr sync --config .validtr/config.yml --mode=reconcile

          echo "❌ Expect FAIL (policy=current) because key revoked"
          set +e
          valiDTr --policy=current verify "$COMMIT1"
          RC0=$?
          set -e
          [ "$RC0" -ne 0 ] || (echo "ERROR: expected current failure (key revoked) but got success" && exit 1)

          echo "✅ Expect PASS (policy=historical) because key was valid at commit time"
          valiDTr --policy=historical verify "$COMMIT1"

          cat > .validtr/config.yml <<'EOF'
          developers: []
          EOF
          valiDTr sync --config .validtr/config.yml --mode=reconcile

          NOW_TS="$(date -u +%s)"
          COMMIT2_TS="$((NOW_TS + 1))"
          export GIT_AUTHOR_DATE="@${COMMIT2_TS}"
          export GIT_COMMITTER_DATE="@${COMMIT2_TS}"

          echo "world" >> file.txt
          git add file.txt
          git commit -m "signed commit 2 after removal"

          unset GIT_AUTHOR_DATE GIT_COMMITTER_DATE

          COMMIT2="$(git rev-parse HEAD)"

          echo "❌ Expect FAIL (policy=current) because dev removed"
          set +e
          valiDTr --policy=current verify-range "$COMMIT1" "$COMMIT2"
          RC=$?
          set -e
          [ "$RC" -ne 0 ] || (echo "ERROR: expected failure but got success" && exit 1)

          echo "✅ Expect PASS: old commit stays valid under policy=historical"
          valiDTr --policy=historical verify "$COMMIT1"

          echo "❌ Expect FAIL: new commit should be rejected under policy=historical"
          set +e
          valiDTr --policy=historical verify "$COMMIT2"
          RC2=$?
          set -e
          [ "$RC2" -ne 0 ] || (echo "ERROR: expected historical failure but got success" && exit 1)

          sleep 2
          cat > .validtr/config.yml <<EOF
          developers:
            - email: demo@example.com
              name: Demo Dev
              keys:
                - id: ${KEYID}
          EOF
          valiDTr sync --config .validtr/config.yml --mode=reconcile

          echo "Expect PASS: old commit stays valid under policy=historical after re-add"
          valiDTr --policy=historical verify "$COMMIT1"

          echo "❌ Expect FAIL: commit during removal stays invalid even after re-add"
          set +e
          valiDTr --policy=historical verify "$COMMIT2"
          RC3=$?
          set -e
          [ "$RC3" -ne 0 ] || (echo "ERROR: expected historical failure after re-add but got success" && exit 1)

          READD_TS="$(date -u +%s)"
          COMMIT3_TS="$((READD_TS + 1))"
          export GIT_AUTHOR_DATE="@${COMMIT3_TS}"
          export GIT_COMMITTER_DATE="@${COMMIT3_TS}"

          echo "again" >> file.txt
          git add file.txt
          git commit -m "signed commit 3 after re-add"

          unset GIT_AUTHOR_DATE GIT_COMMITTER_DATE

          COMMIT3="$(git rev-parse HEAD)"

          echo "✅ Expect PASS: commit after re-add should pass under policy=historical"
          valiDTr --policy=historical verify "$COMMIT3"

          {
            echo "### valiDTr self-test results"
            echo "- Commit1 (before removal): $COMMIT1"
            echo "- Commit2 (after removal):  $COMMIT2"
            echo "- Commit3 (after re-add):   $COMMIT3"
            echo "- KeyID (git %GK):          $KEYID"
            echo "- Expected: Commit1 PASS (current + historical), Commit2 FAIL (current + historical), Commit3 PASS (historical)"
          } >> "$GITHUB_STEP_SUMMARY"
