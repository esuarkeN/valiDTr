name: valiDTr Self-Test

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  selftest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build valiDTr from this repo
        shell: bash
        run: |
          set -euo pipefail
          go test ./...
          go build -o "$RUNNER_TEMP/valiDTr" .
          echo "$RUNNER_TEMP" >> "$GITHUB_PATH"

      - name: Demo PASS -> FAIL (current), old commit still PASS (historical)
        shell: bash
        run: |
          set -euo pipefail

          WORK="$RUNNER_TEMP/demo"
          mkdir -p "$WORK"
          cd "$WORK"
          git init

          export GNUPGHOME="$RUNNER_TEMP/gnupg"
          mkdir -p "$GNUPGHOME"
          chmod 700 "$GNUPGHOME"

          cat >keyparams <<'EOF'
          Key-Type: RSA
          Key-Length: 3072
          Subkey-Type: RSA
          Subkey-Length: 3072
          Name-Real: Demo Dev
          Name-Email: demo@example.com
          Expire-Date: 0
          %no-protection
          %commit
          EOF

          gpg --batch --pinentry-mode loopback --generate-key keyparams

          # export pubkey
          mkdir -p .validtr/pubkeys
          FPR="$(gpg --list-secret-keys --with-colons demo@example.com | awk -F: '$1=="fpr"{print $10; exit}')"
          gpg --armor --export "$FPR" > .validtr/pubkeys/demo.asc

          # IMPORTANT: extract the key-id BEFORE commits (same format as %GK uses)
          KEYID="$(gpg --list-keys --with-colons demo@example.com | awk -F: '$1=="pub"{print $5; exit}')"

          # --- Git signing config ---
          git config user.name "Demo Dev"
          git config user.email "demo@example.com"
          git config commit.gpgsign true
          git config user.signingkey "$FPR"

          # --- Create allowlist config BEFORE commit1 ---
          mkdir -p .validtr
          cat > .validtr/config.yml <<EOF
          developers:
            - email: demo@example.com
              name: Demo Dev
              keys:
                - id: ${KEYID}
          EOF

          # import pubkey into runner keyring so git signature verification succeeds
          gpg --batch --import .validtr/pubkeys/demo.asc >/dev/null

          export VALIDTR_DB="$RUNNER_TEMP/validtr.db"
          rm -f "$VALIDTR_DB"

          # This must create dev/key with an "added_at" that allows existing history.
          # Your sync should do that (epoch) in reconcile mode.
          valiDTr sync --config .validtr/config.yml --mode=reconcile

          # --- Commit 1 ---
          echo "hello" > file.txt
          git add file.txt
          git commit -m "signed commit 1"
          COMMIT1="$(git rev-parse HEAD)"

          ROOT="$(git rev-list --max-parents=0 HEAD)"

          echo "✅ Expect PASS (policy=current)"
          valiDTr --policy=current verify-range "$ROOT" "$COMMIT1"

          echo "✅ Expect PASS (policy=historical)"
          valiDTr --policy=historical verify "$COMMIT1"

          # --- Remove dev from config + reconcile (should set removed_at, NOT delete) ---
          cat > .validtr/config.yml <<'EOF'
          developers: []
          EOF
          valiDTr sync --config .validtr/config.yml --mode=reconcile

          # --- Commit 2 (still signed) ---
          echo "world" >> file.txt
          git add file.txt
          git commit -m "signed commit 2 after removal"
          COMMIT2="$(git rev-parse HEAD)"

          echo "❌ Expect FAIL (policy=current) because dev removed"
          set +e
          valiDTr --policy=current verify-range "$COMMIT1" "$COMMIT2"
          RC=$?
          set -e
          [ "$RC" -ne 0 ] || (echo "ERROR: expected failure but got success" && exit 1)

          echo "✅ Expect PASS: old commit stays valid under policy=historical"
          valiDTr --policy=historical verify "$COMMIT1"


          {
            echo "### valiDTr self-test results"
            echo "- Commit1 (before removal): $COMMIT1"
            echo "- Commit2 (after removal):  $COMMIT2"
            echo "- KeyID:                   $KEYID"
            echo "- Expected: PASS → FAIL(current), and Commit1 PASS(historical)"
          } >> "$GITHUB_STEP_SUMMARY"
